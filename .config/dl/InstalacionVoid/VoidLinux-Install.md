# Void Linux Musl Installation (SATA M.2, btrfs, LVM, full disk encryption using LUKS, 2FA-ish, SSD TRIM)

Here's a record of my experiences when setting up Void Linux for the first time, maybe it contains
useful information for somebody :-)

## Basics
- Laptop: Acer Swift 3
- Void Linux installer version: 2021-09-30 (x86_64 musl)

## Features
This guide explains how to set up Void Linux:
- On an SATA M.2 disk
- Using full disk encryption - **including** /boot, with LUKS + LVM
- Uses btrfs as filesystem
- Offers a poor-man's 2FA using Yubikey's static password feature

## Important notes
- SSD/NVMe trimming **only** works if it is enabled on all intermediate layers, which in this case means LUKS, LVM and btrfs
- What I call "2FA" is not *really* 2FA, but rather a simplistic way to get "something you know" (a passphrase) and "something you have" (a Yubikey token, in my case). Yubikey has a feature to emit a **static** password upon pressing a button on the token. This is modeled as a USB keyboard, so it supports a wide range of hardware. The approach is to make the LUKS passphrase composed of two pieces: First, a password you have to remember, followed directly by the passphrase generated by the token.
- On the web there are several tutorials to configure your YUBIKEY with a static password.
## The process

### Pre-chroot
```bash
# boot Void live system and log in using root:voidlinux

bash
loadkeys es

cp /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant-<interface>.conf
wpa_passphrase <SSID> <password> >> /etc/wpa_supplicant/wpa_supplicant-<interface>.conf
wpa_supplicant -B -i <interface> -c /etc/wpa_supplicant/wpa_supplicant-<interface>.conf

# PARTITION THE DISK
lsblk
wipefs -af /dev/sda

fdisk /dev/sda
# g to create a new GTP partition table
# n new partition with +512M
# t 1 to set partition type to EFI
# n new partition with remaining space

Create GPT partition table
Command (m for help): g

Create EFI System Partition (ESP)
Command (m for help): n
Partition number (1-128, default 1): (enter for default)
First sector (2048-500118158, default 2048): (enter for default)
Last sector, +/-sectors or +/-size{K,M,G,T,P}...): +512M (choose 128M to 1G)
Do you want to remove the signature? [Y]es/[N]o: y
Command (m for help): t
Partition type or alias (type L to list all): 1

Create the root partition
Command (m for help): n
Partition number (2-128, default 2): (enter for default)
First sector (1050624-500118158, default 1050624): (enter for default)
Last sector, +/-sectors or +/-size{K,M,G,T,P}...): (enter for default)

Write changes to the disk
Command (m for help): w

# SET UP ENCRYPTION
# here's the 2FA "trick":
# prepare a YubiKey that emits a *static* passphrase
# when pressing its touch button (best use the maximum
# passphrase length offered - 64 characters at the time
# of writing).
# when asked for the passphrase, *first* enter a
# password you need to *know*, then press the button
# on the Yubikey - voila, you have a passphrase requiring
# something you know and something to have
# not sufficient for government-grade security, maybe, but
# for my humble home laptop, it's OK
cryptsetup luksFormat --type=luks1 /dev/sda2
cryptsetup open /dev/sda2 crypt

# prepare LVM
vgcreate vg0 /dev/mapper/crypt
lvcreate --name swap -L 16G vg0
lvcreate --name void -l +100%FREE vg0

# filesystems
mkfs.vfat -n BOOT -F 32 /dev/sda1
mkswap /dev/mapper/vg0-swap
mkfs.btrfs -L void /dev/mapper/vg0-void

mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60 /dev/mapper/vg0-void /mnt
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
btrfs subvolume create /mnt/@snapshots
umount /mnt
mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@ /dev/mapper/vg0-void /mnt
mkdir /mnt/home
mkdir /mnt/.snapshots
mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@home /dev/mapper/vg0-void /mnt/home/
mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@snapshots /dev/mapper/vg0-void /mnt/.snapshots/
mkdir -p /mnt/boot/efi
mount -o rw,noatime /dev/sda1 /mnt/boot/efi/
mkdir -p /mnt/var/cache
btrfs subvolume create /mnt/var/cache/xbps
btrfs subvolume create /mnt/var/tmp
btrfs subvolume create /mnt/srv
export XBPS_ARCH=x86_64-musl
xbps-install -Sy -R https://alpha.de.repo.voidlinux.org/current/musl -r /mnt base-minimal btrfs-progs cryptsetup lvm2 bash less man-pages e2fsprogs pciutils usbutils iproute2 dhcpcd kbd ethtool kmod iputils xfsprogs f2fs-tools dosfstools traceroute neovim nano ncurses opendoas acpid eudev file mdocml wpa_supplicant iw zsh
mount -t proc proc /mnt/proc/
mount -t sysfs sys /mnt/sys/
mount -o bind /dev /mnt/dev
mount -t devpts pts /mnt/dev/pts
cp -L /etc/resolv.conf /mnt/etc/
cp -L /etc/wpa_supplicant/wpa_supplicant-<interface>.conf /mnt/etc/wpa_supplicant/
chroot /mnt /bin/bash
```

### Post-chroot
```bash
passwd root
chown root:root /
chmod 755 /
echo VoidOS > /etc/hostname
cat <<EOF > /etc/rc.conf
# /etc/rc.conf - system configuration for void

HOSTNAME="VoidOS"
HARDWARECLOCK="UTC"
TIMEZONE="America/Lima"
KEYMAP="la-latin1"
EOF

export UEFI_UUID=$(blkid -s UUID -o value /dev/sda1)
export LUKS_UUID=$(blkid -s UUID -o value /dev/sda2)
export ROOT_UUID=$(blkid -s UUID -o value /dev/mapper/vg0-void)
export SWAP_UUID=$(blkid -s UUID -o value /dev/mapper/vg0-swap)
cat <<EOF > /etc/fstab
UUID=$ROOT_UUID / btrfs rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@ 0 1
UUID=$ROOT_UUID /home btrfs rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@home 0 2
UUID=$ROOT_UUID /.snapshots btrfs rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@snapshots 0 2
UUID=$UEFI_UUID /boot/efi vfat defaults,noatime 0 2
UUID=$SWAP_UUID none swap defaults 0 1
tmpfs /tmp tmpfs defaults,noatime,mode=1777 0 0
EOF
```

### Kernel installation, grub and final configuration
```bash
xbps-install -Sy linux5.15 linux5.15-headers linux-firmware-intel linux-firmware-network dracut
xbps-install -fy linux5.15
xbps-install -y grub-x86_64-efi grub-btrfs
cat <<EOF >> /etc/default/grub
GRUB_ENABLE_CRYPTODISK=y
EOF
sed -i "/GRUB_CMDLINE_LINUX_DEFAULT=/s/\"$/ rd.auto=1 cryptdevice=UUID=$LUKS_UUID:lvm:allow-discards&/" /etc/default/grub
dd bs=512 count=4 if=/dev/urandom of=/boot/volume.key
cryptsetup luksAddKey /dev/sda2 /boot/volume.key
chmod 000 /boot/volume.key
chmod -R g-rwx,o-rwx /boot
cat <<EOF >> /etc/crypttab
crypt /dev/sda2 /boot/volume.key luks
EOF
cat <<EOF >> /etc/dracut.conf.d/10-crypt.conf
install_items+=" /boot/volume.key /etc/crypttab "
EOF
echo 'add_dracutmodules+=" crypt btrfs lvm resume "' >> /etc/dracut.conf
echo 'tmpdir=/tmp' >> /etc/dracut.conf
dracut --force --hostonly --kver $(ls -t /lib/modules | sed 1q)
mkdir /boot/grub
grub-mkconfig -o /boot/grub/grub.cfg
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=void --boot-directory=/boot  --recheck

# Ending
xbps-reconfigure -fa
exit
umount -R /mnt
shutdown -r now
```

###  Post installation
```bash
ln -s /etc/sv/dhcpcd /var/service
ln -s /etc/sv/wpa_supplicant/ /var/service

# Network WIFI configuration

wpa_cli

> scan
OK
<3>CTRL-EVENT-SCAN-STARTED
<3>CTRL-EVENT-SCAN-RESULTS
> scan_results

> add_network
0
> set_network 0 ssid "<nama_ssid>"
OK
> set_network 0 psk "<password_dari_ssid>"
OK


> select_network 0
OK
> enable_network 0
OK
> save_config
OK
> quit

# to see the list of networks that have been added using list_networks to check if you are connected to the internet can ping

xbps-install -S zsh #YA FUE INTALADO ANTES

# Normal user and privileges
useradd -m -s /bin/zsh -U -G wheel,disk,audio,video,storage,network,xbuilder,input,users YOUR_USER
passwd YOUR_USER

# Delete SUDO
echo "ignorepkg=sudo" > /etc/xbps.d/10-ignore.conf
xbps-remove sudo

touch /etc/doas.conf
echo "permit :wheel" > /etc/doas.conf
echo "permit persist :wheel" >> /etc/doas.conf

# Remove some unused Runit services
rm /var/service/{agetty-tty4,agetty-tty5,agetty-tty6}
rm /var/service/sshd

# Graphical user interface
# xorg
doas xbps-install -S xorg-minimal xwininfo xprop xdpyinfo xset xsetroot xrdb # xorg-server-devel xterm

# core
doas xbps-install -S xcape setxkbmap efivar mlocate readline-devel lm_sensors pkg-config man-db wget zip unzip # unrar
doas xbps-install -S dosfstools ntfs-3g xdg-user-dirs xtools xdg-utils xclip xdo xdotool mediainfo elogind bc tree

# fonts
doas xbps-install -S dejavu-fonts-ttf noto-fonts-ttf noto-fonts-emoji
doas xbps-install -S liberation-fonts-ttf font-inconsolata-otf  # terminus-font font-awesome

# audio
#doas xbps-install -S pulseaudio alsa-plugins-pulseaudio pulsemixer pamixer # Do not use
#doas ln -s /etc/sv/pulseaudio/ /var/service # Do not use
doas xbps-install -S elogind pipewire pamixer
doas ln -srf /etc/sv/{elogind,pipewire,pipewire-pulse} /var/service
doas usermod -aG _pipewire $USER


# File manager for android
doas xbps-install -S Thunar gvfs gvfs-mtp
doas ln -s /etc/sv/polkitd/ /var/service

# others
doas xbps-install -S calcurse yt-dlp ffmpeg maim sxiv feh ImageMagick # xwallpaper
doas xbps-install -S picom mpd mpc mpv ncmpcpp # newsboat rsync
doas xbps-install -S zathura zathura-pdf-mupdf poppler python3-adblock cronie jq
doas xbps-install -S dunst libnotify htop bat moreutils git curl # gucharmap transmission tremc 
doas xbps-install -S qutebrowser lf upower unclutter-xfixes # qrencode steam Signal-Desktop
doas xbps-install -S base-devel make libXrandr-devel libX11-devel libXft-devel libXinerama-devel # imlib2-devel harfbuzz-devel

# mail (I do not use Mail)
doas xbps-install -S neomutt notmuch isync msmtp

# Other for personal work
VeraCrypt Thunar 
lxappearance xbacklight xarchiver geany xmodmap xorg-fonts  # Do not use xf86-video-intel


# NEXT COPY YOUR DOTFILES AND FONTS
fc-cache -fv
setxkbmap latam

# For test dunst 
notify-send -u low -t 0 "Low sumary" "Low body"
notify-send -u low -t 0 "Low sumary" "Low body"
notify-send -u normal -t 0 "Normal sumary" "Normal body"
notify-send -u critical -t 0 "Critical sumary" "Critical body"
notify-send -u critical -t 0 "test" "Critical body"

xbps-install dbus
ln -s /etc/sv/dbus/ /var/service
sed -i 's/issue_discards = 0/issue_discards = 1/' /etc/lvm/lvm.conf
```

###  Others (after logging in as normal user)
```bash
# VIDEO DRIVERS & DISPALY SERVER
# Install the OpenGL driver for both Intel and AMD
doas xbps-install mesa-dri

# Install the Khronos Vulkan Loader for both Intel and AMD
doas xbps-install vulkan-loader # already install

# INTEL
# Install the mesa vulkan driver
doas xbps-install mesa-vulkan-intel

# Install the video acceleration driver
doas xbps-install intel-video-accel

# Remove the Intel DDX driver to ensure xorg uses modesetting
doas echo 'ignorepkg=xf86-video-intel' >> /etc/xbps.d/10-ignore.conf
#doas echo 'ignorepkg=xf86-video-intel' >> /etc/xbps.d/00-repository-main.conf # Do not use
doas xbps-remove xf86-video-intel

# Void-packages and xbps-src
doas xbps-install -Sy git #YA FUE INSTALADO
git clone https://github.com/void-linux/void-packages.git
cd void-packages
./xbps-src binary-bootstrap
echo XBPS_ALLOW_RESTRICTED=yes >> etc/conf
    - For builde a package:
        ./xbps-src pkg <package_name>
        doas xbps-install -S xtools
        cd void-packages/masterdir
        xi <package_name>

# libxft patch
cd void-packages/srcpkgs/libXft
mkdir patches
# Copy the patch inside patches directory:
   cd void-packages
   ./xbps-src pkg -f libXft
   doas xbps-install -R ./hostdir/binpkgs -f libXft
   doas xbps-install -R ./hostdir/binpkgs -f libXft-devel
   doas xbps-pkgdb -m repolock libXft  # avoid overwritten by updates
   
# Picom-ibhagwan (for rounded corners and transparencies)
git clone https://github.com/ibhagwan/picom-ibhagwan-template
mv picom-ibhagwan-template <path_void-packages>/srcpkgs/picom-ibhagwan
cd <path_void-packages>
./xbps-src pkg picom-ibhagwan
doas xbps-install --repository=hostdir/binpkgs picom-ibhagwan
```

###  To rescue the system enter CHROOT from liveCD
```bash
cryptsetup open /dev/sda2 crypt
lvchange -ay /dev/vg0/void
lvchange -ay /dev/vg0/swap
lvdisplay vg0

mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@ /dev/vg0/void /mnt
mount -o rw,noatime,ssd,compress=lzo,space_cache,commit=60,subvol=@home /dev/vg0/void /mnt/home/
mount -o rw,noatime /dev/sda1 /mnt/boot/efi/
mount -t proc proc /mnt/proc/
mount -t sysfs sys /mnt/sys/
mount -o bind /dev /mnt/dev
mount -t devpts pts /mnt/dev/pts
chroot /mnt /bin/bash

# After solving reboot the system
exit
umount -R /mnt
shutdown -r now
```

## References
As per "standing on the shoulders of giants", most of the information in this guide was no
discovered by myself, but rather assembled from various existing guides, which I want to list
here to give credit where credit is due:

[1] https://gist.github.com/tobi-wan-kenobi/bff3af81eac27e210e1dc88ba660596e

[2] https://www.yubico.com/resources/glossary/static-password/

[3] https://gist.github.com/gbrlsnchs/9c9dc55cd0beb26e141ee3ea59f26e21

[4] https://wiki.voidlinux.org/Full_Disk_Encryption_w/Encrypted_Boot

[5] https://gist.github.com/mattiaslundberg/8620837

[6] http://blog.neutrino.es/2013/howto-properly-activate-trim-for-your-ssd-on-linux-fstrim-lvm-and-dmcrypt/
